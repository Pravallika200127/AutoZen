name: AutoZen Cross-Browser CI/CD Pipeline

on:
  #  Run on every push to any branch
  push:
    branches:
      - '**'
  #  Run on every PR merge or update
  pull_request:
    branches:
      - '**'
  #  Scheduled run daily at 7:30 AM IST (2:00 AM UTC)
  schedule:
    - cron: '0 2 * * *'
  #  Allow manual trigger
  workflow_dispatch:

jobs:
  test:
    name: Run on ${{ matrix.browser }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - browser: chrome
            os: ubuntu-latest
          - browser: firefox
            os: ubuntu-latest
          - browser: edge
            os: ubuntu-latest
          - browser: safari
            os: macos-latest

    env:
      JAVA_VERSION: 21
      MAVEN_OPTS: -Xmx2048m
      HEADLESS: true
      TESTRAIL_ENABLED: true
      TESTRAIL_USERNAME: ${{ secrets.TESTRAIL_USERNAME }}
      TESTRAIL_APIKEY: ${{ secrets.TESTRAIL_APIKEY }}
      TESTRAIL_LABEL: Autozentestsuite

    steps:
      - name:  Checkout Repository
        uses: actions/checkout@v4

      - name:  Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      #  Browser Installations (Stable & Compatible Versions)
      - name:  Install Chrome (latest stable)
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
          install-chromedriver: true

      - name:  Install Firefox (latest ESR)
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1
        with:
          firefox-version: latest-esr

      - name:  Install Edge (latest stable)
        if: matrix.browser == 'edge'
        uses: browser-actions/setup-edge@v1
        with:
          edge-version: stable

      - name:  Enable Safari WebDriver (macOS)
        if: matrix.browser == 'safari'
        run: |
          echo " Enabling Safari WebDriver..."
          safaridriver --enable || true

      #  Cache Maven Dependencies
      - name:  Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: maven-

      #  Build Project
      - name:  Build Project
        run: mvn clean compile -B

      #  Execute Tests with Browser Matrix
      - name:  Run Cross-Browser Tests
        run: |
          echo " Running tests on Browser: ${{ matrix.browser }}"
          mvn test \
            -Dsurefire.suiteXmlFiles=testng.xml \
            -Dbrowser=${{ matrix.browser }} \
            -Dheadless=${{ env.HEADLESS }} \
            -Dtestrail.enabled=${{ env.TESTRAIL_ENABLED }} \
            -Dtestrail.username="${{ secrets.TESTRAIL_USERNAME }}" \
            -Dtestrail.apikey="${{ secrets.TESTRAIL_APIKEY }}" \
            -Dtestrail.labels="${{ env.TESTRAIL_LABEL }}" \
            -Dextent.report.dir=test-output
        continue-on-error: true

      #  Upload Extent Reports & Screenshots
      - name:  Upload Extent Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ExtentReport-${{ matrix.browser }}
          path: |
            test-output/ExtentReport.html
            test-output/screenshots/**

      #  Summary
      - name:  Summary
        if: always()
        run: |
          echo " All cross-browser test runs completed."
          echo " Label used for TestRail run: ${{ env.TESTRAIL_LABEL }}"
          echo " Reports saved as GitHub Artifacts."
