name: üß© AutoZen Cross-Browser CI/CD Pipeline

on:
  push:
    branches:
      - main
      - AutoZen_Integration
  pull_request:
    branches:
      - main
      - AutoZen_Integration
  schedule:
    # üïñ Runs every day at 7:30 AM IST (02:00 UTC)
    - cron: '30 2 * * *'
  workflow_dispatch:

jobs:
  test:
    name: Run on ${{ matrix.browser }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - browser: chrome
            os: ubuntu-latest
          - browser: firefox
            os: ubuntu-latest
          - browser: edge
            os: ubuntu-latest
          - browser: safari
            os: macos-latest

    env:
      JAVA_VERSION: 21
      MAVEN_OPTS: -Xmx2048m
      HEADLESS: true
      TESTRAIL_ENABLED: true
      TESTRAIL_LABEL: Autozentestsuite
      TESTRAIL_USERNAME: ${{ secrets.TESTRAIL_USERNAME }}
      TESTRAIL_APIKEY: ${{ secrets.TESTRAIL_APIKEY }}

    steps:
      # ==========================================================
      #  Step 1: Checkout Repository
      # ==========================================================
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      # ==========================================================
      #  Step 2: Set up Java (Temurin JDK)
      # ==========================================================
      - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      # ==========================================================
      #  Step 3: Install Browsers
      # ==========================================================
      - name: üß© Set up Chrome
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@v1

      - name: üß© Set up Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1

            # ==========================================================
      #  Step 5.6: Ensure Edge Browser + EdgeDriver Installed
      # ==========================================================
      - name: üü£ Ensure Edge + Driver installed
        if: matrix.browser == 'edge'
        run: |
          echo "üß© Installing Microsoft Edge and matching EdgeDriver..."
          sudo apt-get update
          sudo apt-get install -y curl unzip software-properties-common apt-transport-https
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge.list'
          sudo apt-get update
          sudo apt-get install -y microsoft-edge-stable

          # Get Edge version
          EDGE_VERSION=$(microsoft-edge --version | awk '{print $3}')
          echo "üîç Detected Edge version: $EDGE_VERSION"

          # Download matching EdgeDriver version
          wget -q "https://msedgedriver.azureedge.net/${EDGE_VERSION}/edgedriver_linux64.zip" -O /tmp/edgedriver.zip || true
          if [ ! -f /tmp/edgedriver.zip ]; then
            echo "‚ö†Ô∏è Version-specific driver not found, downloading latest stable..."
            wget -q "https://msedgedriver.azureedge.net/LATEST_RELEASE" -O /tmp/latest_version.txt
            LATEST_VERSION=$(cat /tmp/latest_version.txt)
            wget -q "https://msedgedriver.azureedge.net/${LATEST_VERSION}/edgedriver_linux64.zip" -O /tmp/edgedriver.zip
          fi

          unzip -o /tmp/edgedriver.zip -d /usr/local/bin/
          chmod +x /usr/local/bin/msedgedriver
          which msedgedriver
          msedgedriver --version


      - name: üß© Enable Safari (macOS only)
        if: matrix.browser == 'safari'
        run: |
          echo "‚úÖ Enabling SafariDriver..."
          safaridriver --enable || true
          sudo safaridriver --enable
          safaridriver --version

      # ==========================================================
      #  Step 4: Cache Maven Dependencies
      # ==========================================================
      - name: üì¶ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: maven-

      # ==========================================================
      #  Step 5: Build Project
      # ==========================================================
      - name: ‚öôÔ∏è Build Project
        run: mvn clean compile -B

      # ==========================================================
      #  Step 6: Run Cross-Browser Tests
      # ==========================================================
      - name: üöÄ Run Tests on ${{ matrix.browser }}
        run: |
          echo "üß™ Running tests on ${{ matrix.browser }}..."
          mvn test \
            -Dsurefire.suiteXmlFiles=testng.xml \
            -Dbrowser=${{ matrix.browser }} \
            -Dheadless=${{ env.HEADLESS }} \
            -Dwdm.offline=true \
            -Dtestrail.labels=${{ env.TESTRAIL_LABEL }} \
            -Dtestrail.username="${{ secrets.TESTRAIL_USERNAME }}" \
            -Dtestrail.apikey="${{ secrets.TESTRAIL_APIKEY }}" \
            -Dtestrail.enabled=${{ env.TESTRAIL_ENABLED }}
        continue-on-error: ${{ matrix.browser == 'safari' }}

      # ==========================================================
      #  Step 7: Upload Artifacts (Extent Reports)
      # ==========================================================
      - name: üìä Upload Extent Report (${{ matrix.browser }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ExtentReport-${{ matrix.browser }}
          path: |
            test-output/ExtentReport.html
            test-output/screenshots/

      # ==========================================================
      #  Step 8: Summary
      # ==========================================================
      - name: üßæ Summary
        if: always()
        run: |
          echo "‚úÖ All cross-browser executions completed."
          echo "üíæ Extent Reports saved in GitHub Artifacts."
          echo "üîó TestRail results automatically updated for label: ${{ env.TESTRAIL_LABEL }}."
